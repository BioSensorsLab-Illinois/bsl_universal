name: CI

on:
  push:
    branches: [main, master]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-check:
    name: "${{ matrix.platform.id }} | py${{ matrix.python-version }}"
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - id: windows
            runner: windows-2022
          - id: macos
            runner: macos-26
          - id: linux
            runner: ubuntu-22.04
          - id: linux-arm
            runner: ubuntu-22.04-arm
          - id: macos15-arm
            runner: macos-15
          - id: macos15-x86
            runner: macos-15-intel
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]
        exclude:
          - platform:
              id: linux-arm
              runner: ubuntu-22.04-arm
            python-version: "3.14"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install Linux system dependencies
        if: startsWith(matrix.platform.runner, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libhdf5-dev \
            libusb-1.0-0-dev \
            libudev-dev \
            pkg-config

      - name: Ensure libusb pkg-config alias (Linux)
        if: startsWith(matrix.platform.runner, 'ubuntu')
        run: |
          MULTIARCH="$(dpkg-architecture -qDEB_HOST_MULTIARCH)"
          for dir in "/usr/lib/${MULTIARCH}/pkgconfig" "/usr/lib/pkgconfig" "/usr/local/lib/pkgconfig"; do
            if [ -f "${dir}/libusb-1.0.pc" ] && [ ! -f "${dir}/libusb.pc" ]; then
              sudo cp "${dir}/libusb-1.0.pc" "${dir}/libusb.pc"
              sudo sed -i 's/^Name:.*/Name: libusb/' "${dir}/libusb.pc"
              break
            fi
          done

      - name: Configure HDF5 environment (Linux)
        if: startsWith(matrix.platform.runner, 'ubuntu')
        run: |
          MULTIARCH="$(dpkg-architecture -qDEB_HOST_MULTIARCH)"
          HDF5_DIR="/usr/lib/$(dpkg-architecture -qDEB_HOST_MULTIARCH)/hdf5/serial"
          echo "HDF5_DIR=${HDF5_DIR}" >> "$GITHUB_ENV"
          echo "PKG_CONFIG_PATH=/usr/lib/${MULTIARCH}/pkgconfig:${HDF5_DIR}/pkgconfig:${HDF5_DIR}/lib/pkgconfig:${PKG_CONFIG_PATH:-}" >> "$GITHUB_ENV"
          echo "LD_LIBRARY_PATH=${HDF5_DIR}:${LD_LIBRARY_PATH:-}" >> "$GITHUB_ENV"

      - name: Verify Linux native deps
        if: startsWith(matrix.platform.runner, 'ubuntu')
        run: |
          pkg-config --modversion libusb || pkg-config --modversion libusb-1.0
          pkg-config --modversion hdf5 || true

      - name: Install package
        run: python -m pip install --prefer-binary .

      - name: Compile package
        run: python -m compileall -q bsl_universal

      - name: Import smoke test
        run: python -c "import bsl_universal; print(bsl_universal.__name__)"

  unified-wheel:
    name: "unified wheel | py3-none-any"
    runs-on: ubuntu-22.04
    needs: build-and-check
    outputs:
      release_version: ${{ steps.bump.outputs.release_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.8"

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install wheel build tooling
        run: python -m pip install build twine

      - name: Auto increment package version (major=2)
        id: bump
        run: |
          python - <<'PY'
          import json
          import os
          import re
          import urllib.request
          from pathlib import Path

          package_name = "bsl-universal"
          forced_major = 2
          setup_path = Path("setup.py")
          text = setup_path.read_text(encoding="utf-8")

          local_match = re.search(r"version\s*=\s*['\"]([^'\"]+)['\"]", text)
          if not local_match:
              raise SystemExit("Unable to parse version from setup.py")

          local_version = local_match.group(1).strip()
          local_parts = local_version.split(".")
          local_minor = 0
          local_patch = 0
          if len(local_parts) == 3 and local_parts[0].isdigit() and local_parts[1].isdigit() and local_parts[2].isdigit():
              if int(local_parts[0]) == forced_major:
                  local_minor = int(local_parts[1])
                  local_patch = int(local_parts[2])

          releases = []
          try:
              with urllib.request.urlopen(f"https://pypi.org/pypi/{package_name}/json", timeout=20) as resp:
                  payload = json.load(resp)
              for version in payload.get("releases", {}):
                  m = re.fullmatch(r"(\d+)\.(\d+)\.(\d+)", str(version).strip())
                  if not m:
                      continue
                  major, minor, patch = map(int, m.groups())
                  if major == forced_major:
                      releases.append((minor, patch))
          except Exception:
              # Network lookup failure should not block CI release assembly.
              releases = []

          if releases:
              minor, patch = max(releases)
              patch += 1
              if patch > 99:
                  patch = 0
                  minor += 1
          else:
              minor, patch = local_minor, local_patch

          release_version = f"{forced_major}.{minor}.{patch}"

          updated_text, count = re.subn(
              r"version\s*=\s*['\"][^'\"]+['\"]",
              f"version = '{release_version}'",
              text,
              count=1,
          )
          if count != 1:
              raise SystemExit("Failed to rewrite version in setup.py")

          setup_path.write_text(updated_text, encoding="utf-8")
          print(f"Resolved release version: {release_version}")

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
              fh.write(f"release_version={release_version}\\n")
          PY

      - name: Build unified distributions
        run: python -m build --sdist --wheel

      - name: Verify wheel tag
        env:
          RELEASE_VERSION: ${{ steps.bump.outputs.release_version }}
        run: |
          python - <<'PY'
          import os
          import pathlib

          release_version = os.environ["RELEASE_VERSION"]
          wheels = list(pathlib.Path("dist").glob("*.whl"))
          if len(wheels) != 1:
              raise SystemExit(f"Expected exactly 1 wheel, found {len(wheels)}: {[w.name for w in wheels]}")

          wheel_name = wheels[0].name
          if "py3-none-any" not in wheel_name:
              raise SystemExit(f"Expected unified wheel tag 'py3-none-any', got: {wheel_name}")
          if f"-{release_version}-" not in wheel_name:
              raise SystemExit(f"Wheel does not contain expected version {release_version}: {wheel_name}")

          sdists = list(pathlib.Path("dist").glob("*.tar.gz"))
          if len(sdists) != 1:
              raise SystemExit(f"Expected exactly 1 sdist, found {len(sdists)}: {[s.name for s in sdists]}")
          sdist_name = sdists[0].name
          if f"-{release_version}.tar.gz" not in sdist_name:
              raise SystemExit(f"sdist does not contain expected version {release_version}: {sdist_name}")

          print(f"Unified wheel verified: {wheel_name}")
          print(f"sdist verified: {sdist_name}")
          PY

      - name: Validate distribution metadata
        run: python -m twine check dist/*

      - name: Upload distribution artifact
        uses: actions/upload-artifact@v4
        with:
          name: bsl-universal-dist
          path: dist/*
          if-no-files-found: error

  publish-pypi:
    name: "publish to pypi"
    runs-on: ubuntu-22.04
    needs: [unified-wheel]
    if: >-
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    concurrency:
      group: pypi-publish
      cancel-in-progress: false
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download distribution artifact
        uses: actions/download-artifact@v4
        with:
          name: bsl-universal-dist
          path: dist

      - name: Show release version
        run: echo "Publishing version ${{ needs.unified-wheel.outputs.release_version }} to PyPI"

      - name: Publish distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
